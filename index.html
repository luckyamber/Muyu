<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯å®šæ™‚å¿µç¶“æ©Ÿ 3.1 (å¤§æ‚²å’’ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --text-gold: #cfaa6e;
            --text-dim: #666;
            --accent-red: #d45d5d;
            --accent-green: #5d9e5d;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-gold);
            font-family: 'Noto Serif TC', serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ç¦ªæ„èƒŒæ™¯ */
        .lotus-bg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60vh;
            opacity: 0.08;
            pointer-events: none;
            z-index: 0;
            filter: grayscale(100%) sepia(30%);
            user-select: none;
        }

        /* è²éŸ³æ§åˆ¶é¢æ¿ */
        .sound-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 25;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sound-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid #444;
            color: #aaa;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .sound-toggle.active {
            background: rgba(207, 170, 110, 0.2);
            border-color: var(--text-gold);
            color: var(--text-gold);
        }

        .sound-toggle:hover { background: rgba(255,255,255,0.2); }

        /* å³ä¸Šé¸å–® */
        .top-menu {
            position: absolute;
            top: 20px; right: 20px;
            z-index: 20;
        }
        select {
            background: rgba(0,0,0,0.6);
            color: var(--text-gold);
            border: 1px solid var(--text-gold);
            padding: 8px 15px;
            font-family: inherit;
            border-radius: 20px;
            cursor: pointer;
            outline: none;
        }

        /* ç¶“æ–‡æ»¾å‹•å€ */
        .scripture-viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            z-index: 10;
            mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);
            display: flex;
            justify-content: center;
        }

        .scroll-content {
            position: absolute;
            top: 100%;
            width: 80%;
            max-width: 600px;
            text-align: center;
            font-size: 2rem;
            line-height: 2;
            white-space: pre-wrap;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(207, 170, 110, 0.3);
            padding-bottom: 100px;
        }

        .scrolling {
            animation-name: scrollUp;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        @keyframes scrollUp {
            from { transform: translateY(0); }
            to { transform: translateY(-130%); } /* å‘ä¸Šæ²å‹• */
        }

        /* æ§åˆ¶æŒ‰éˆ•å€ */
        .controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 30;
        }

        button.main-btn {
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .btn-start { background: var(--text-gold); color: #1a1a1a; }
        .btn-start:hover { transform: scale(1.05); background: #fff; }
        
        .btn-pause { background: #444; color: #fff; }
        
        .btn-stop { background: var(--accent-red); color: #fff; }
        .btn-stop:hover { transform: scale(1.05); background: #ff7676; }

        /* è¨ˆæ•¸å™¨ */
        .counter-box {
            position: absolute;
            bottom: 20px; right: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #333;
            z-index: 20;
            font-size: 1rem;
        }
        .count-num { font-size: 1.4rem; font-weight: bold; color: #fff; }

        /* å›å‘è¦–çª— & Banner */
        .dedication-banner {
            background: linear-gradient(90deg, #d45d5d, #b53f3f);
            color: #fff;
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            display: none;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            animation: slideDown 0.5s ease-out;
        }
        @keyframes slideDown { from {transform: translateY(-100%);} to {transform: translateY(0);} }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 50; display: none;
            justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        
        .modal-content {
            background: #222;
            border: 1px solid var(--text-gold);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%; width: 320px;
        }
        .modal-input {
            width: 80%; padding: 12px; margin: 15px 0;
            background: #333; border: 1px solid #555;
            color: #fff; border-radius: 5px; text-align: center;
        }
        .close-modal { margin-top: 10px; background: transparent; color: #666; border: none; cursor: pointer; }
        .close-modal:hover { color: #fff; }

        /* æ‰‹æ©Ÿ RWD */
        @media (max-width: 600px) {
            .sound-panel { flex-direction: column; align-items: flex-start; }
            .scroll-content { font-size: 1.5rem; width: 90%; }
        }
    </style>
</head>
<body>

    <div class="lotus-bg">ğŸª·</div>
    <div id="dedicationBanner" class="dedication-banner"></div>

    <!-- å·¦ä¸Šè²éŸ³æ§åˆ¶ -->
    <div class="sound-panel">
        <button id="muyuToggle" class="sound-toggle active">
            ğŸª˜ é›»å­æœ¨é­š (é–‹)
        </button>
        <button id="ttsToggle" class="sound-toggle">
            ğŸ—£ï¸ AI èª¦è®€ (é—œ)
        </button>
    </div>

    <div class="top-menu">
        <select id="scriptureSelect">
            <option value="heart">èˆ¬è‹¥æ³¢ç¾…èœœå¤šå¿ƒç¶“</option>
            <option value="dabeizhou">å¤§æ‚²å’’ (åƒæ‰‹åƒçœ¼)</option>
            <option value="om">å…­å­—å¤§æ˜å’’</option>
        </select>
    </div>

    <div class="scripture-viewport">
        <div id="scrollText" class="scroll-content"></div>
    </div>

    <div class="controls">
        <button id="startBtn" class="main-btn btn-start">æ•²æˆ‘æ¶ˆæ¥­éšœ â–¶</button>
        <button id="pauseBtn" class="main-btn btn-pause" style="display:none;">ä¸”æ…¢ â¸</button>
        <button id="stopBtn" class="main-btn btn-stop" style="display:none;">åŠŸå¾·åœ“æ»¿ â¹</button>
    </div>

    <div class="counter-box">
        å·²å¿µ <span id="countNum" class="count-num">0</span> é
    </div>

    <!-- å›å‘ Modal -->
    <div id="dedicationModal" class="modal-overlay">
        <div class="modal-content">
            <h3>ğŸ™ æ–½ä¸»åŠŸå¾·ç„¡é‡</h3>
            <p>æœ¬æ¬¡å…±å¿µèª¦ <span id="finalCount" style="color:var(--text-gold); font-weight:bold;"></span> éã€‚</p>
            <input type="text" id="dedicateTo" class="modal-input" placeholder="ä¾‹ï¼šå…¨å®¶å¹³å®‰ã€æˆ‘çš„è²“ã€ä¸–ç•Œå’Œå¹³">
            <button id="shareBtn" class="main-btn btn-start" style="width:100%">ç”¢ç”Ÿå›å‘é€£çµ</button>
            <button id="closeModal" class="close-modal">ä¸å›å‘ï¼Œé—œé–‰</button>
            <div id="shareResult" style="margin-top:15px; color:#888; display:none; font-size:0.9rem;">
                é€£çµå·²è¤‡è£½ï¼<br>å‚³çµ¦æœ‹å‹åˆ†äº«åŠŸå¾·ã€‚
            </div>
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™åº« (å·²æ–°å¢å¤§æ‚²å’’) ---
        const scriptures = {
            heart: `è§€è‡ªåœ¨è©è–© è¡Œæ·±èˆ¬è‹¥æ³¢ç¾…èœœå¤šæ™‚ ç…§è¦‹äº”è˜Šçš†ç©º åº¦ä¸€åˆ‡è‹¦å„\n\nèˆåˆ©å­ è‰²ä¸ç•°ç©º ç©ºä¸ç•°è‰² è‰²å³æ˜¯ç©º ç©ºå³æ˜¯è‰²\nå—æƒ³è¡Œè­˜ äº¦å¾©å¦‚æ˜¯\n\nèˆåˆ©å­ æ˜¯è«¸æ³•ç©ºç›¸ ä¸ç”Ÿä¸æ»… ä¸å¢ä¸æ·¨ ä¸å¢ä¸æ¸›\næ˜¯æ•…ç©ºä¸­ç„¡è‰² ç„¡å—æƒ³è¡Œè­˜\nç„¡çœ¼è€³é¼»èˆŒèº«æ„ ç„¡è‰²è²é¦™å‘³è§¸æ³•\nç„¡çœ¼ç•Œ ä¹ƒè‡³ç„¡æ„è­˜ç•Œ\nç„¡ç„¡æ˜ äº¦ç„¡ç„¡æ˜ç›¡ ä¹ƒè‡³ç„¡è€æ­» äº¦ç„¡è€æ­»ç›¡\nç„¡è‹¦é›†æ»…é“ ç„¡æ™ºäº¦ç„¡å¾— ä»¥ç„¡æ‰€å¾—æ•…\n\nè©æè–©åŸµ ä¾èˆ¬è‹¥æ³¢ç¾…èœœå¤šæ•… å¿ƒç„¡ç½£ç¤™\nç„¡ç½£ç¤™æ•… ç„¡æœ‰ææ€– é é›¢é¡›å€’å¤¢æƒ³ ç©¶ç«Ÿæ¶…æ§ƒ\nä¸‰ä¸–è«¸ä½› ä¾èˆ¬è‹¥æ³¢ç¾…èœœå¤šæ•… å¾—é˜¿è€¨å¤šç¾…ä¸‰è—ä¸‰è©æ\n\næ•…çŸ¥èˆ¬è‹¥æ³¢ç¾…èœœå¤š æ˜¯å¤§ç¥å’’ æ˜¯å¤§æ˜å’’ æ˜¯ç„¡ä¸Šå’’ æ˜¯ç„¡ç­‰ç­‰å’’\nèƒ½é™¤ä¸€åˆ‡è‹¦ çœŸå¯¦ä¸è™›\n\næ•…èªªèˆ¬è‹¥æ³¢ç¾…èœœå¤šå’’ å³èªªå’’æ›°\næ­è«¦æ­è«¦ æ³¢ç¾…æ­è«¦ æ³¢ç¾…åƒ§æ­è«¦ è©æè–©å©†è¨¶`,
            
            dabeizhou: `å—ç„¡å–å›‰æ€›é‚£å“†å›‰å¤œè€¶\nå—ç„¡é˜¿å”è€¶ å©†ç›§ç¾¯å¸çˆç¼½å›‰è€¶ è©æè–©åŸµå©†è€¶\næ‘©è¨¶è–©åŸµå©†è€¶ æ‘©è¨¶è¿¦ç›§å°¼è¿¦è€¶ å”µ\nè–©çš¤å›‰ç½°æ›³ æ•¸æ€›é‚£æ€›å¯« å—ç„¡æ‚‰å‰æ —åŸµä¼Šè’™é˜¿å”è€¶\nå©†ç›§å‰å¸å®¤ä½›å›‰æ¥é¦±å©† å—ç„¡é‚£å›‰è¬¹å¢€\né†¯åˆ©æ‘©è¨¶çš¤å“†æ²™å’© è–©å©†é˜¿ä»–è±†è¼¸æœ‹\né˜¿é€å­• è–©å©†è–©å“† é‚£æ‘©å©†è–©å“† é‚£æ‘©å©†ä¼½\næ‘©ç½°ç‰¹è±† æ€›å§ªä»– å”µ é˜¿å©†ç›§é†¯\nç›§è¿¦å¸ è¿¦ç¾…å¸ å¤·é†¯å” æ‘©è¨¶è©æè–©åŸµ\nè–©å©†è–©å©† æ‘©å›‰æ‘©å›‰ æ‘©é†¯æ‘©é†¯å”é¦±å­•\nä¿±ç›§ä¿±ç›§ç¾¯è’™ åº¦ç›§åº¦ç›§ç½°é—è€¶å¸ æ‘©è¨¶ç½°é—è€¶å¸\né™€å›‰é™€å›‰ åœ°å”å°¼ å®¤ä½›å›‰è€¶ é®å›‰é®å›‰\næ‘©éº¼ç½°æ‘©å›‰ ç©†å¸éš¸ ä¼Šé†¯ä¼Šé†¯ å®¤é‚£å®¤é‚£\né˜¿å›‰åƒä½›å›‰èˆåˆ© ç½°æ²™ç½°åƒ ä½›å›‰èˆè€¶\nå‘¼åš§å‘¼åš§æ‘©å›‰ å‘¼åš§å‘¼åš§é†¯åˆ©\nå¨‘å›‰å¨‘å›‰ æ‚‰å”æ‚‰å” è˜‡åš§è˜‡åš§\nè©æå¤œè©æå¤œ è©è–©å¤œè©è–©å¤œ å½Œå¸å”å¤œ é‚£å›‰è¬¹å¢€\nåœ°åˆ©ç‘Ÿå°¼é‚£ æ³¢å¤œæ‘©é‚£ å¨‘å©†è¨¶\næ‚‰é™€å¤œ å¨‘å©†è¨¶ æ‘©è¨¶æ‚‰é™€å¤œ å¨‘å©†è¨¶\næ‚‰é™€å–»è— å®¤çš¤å›‰è€¶ å¨‘å©†è¨¶ é‚£å›‰è¬¹å¢€ å¨‘å©†è¨¶\næ‘©å›‰é‚£å›‰ å¨‘å©†è¨¶ æ‚‰å›‰åƒ§é˜¿ç©†ä½‰è€¶ å¨‘å©†è¨¶\nå¨‘å©†æ‘©è¨¶é˜¿æ‚‰é™€å¤œ å¨‘å©†è¨¶\nè€…å‰å›‰é˜¿æ‚‰é™€å¤œ å¨‘å©†è¨¶ æ³¢é™€æ‘©ç¾¯æ‚‰é™€å¤œ å¨‘å©†è¨¶\né‚£å›‰è¬¹å¢€çš¤ä¼½å›‰è€¶ å¨‘å©†è¨¶\næ‘©å©†åˆ©å‹ç¾¯å›‰å¤œ å¨‘å©†è¨¶\nå—ç„¡å–å›‰æ€›é‚£å“†å›‰å¤œè€¶ å—ç„¡é˜¿å”è€¶\nå©†ç›§å‰å¸ çˆçš¤å›‰å¤œ å¨‘å©†è¨¶\nå”µ æ‚‰æ®¿éƒ½ æ¼«å¤šå›‰ è·‹é™€è€¶ å¨‘å©†è¨¶`,
            
            om: `å”µ å˜› å‘¢ å­ å’ª å½\nå”µ å˜› å‘¢ å­ å’ª å½\nå”µ å˜› å‘¢ å­ å’ª å½\nå”µ å˜› å‘¢ å­ å’ª å½\nå”µ å˜› å‘¢ å­ å’ª å½\nå”µ å˜› å‘¢ å­ å’ª å½`
        };

        // æ»¾å‹•é€Ÿåº¦ (ç§’) - å¤§æ‚²å’’è¨­å®šç‚º 90ç§’
        const speeds = { heart: 45, dabeizhou: 90, om: 10 }; 

        // --- 2. è²éŸ³ç³»çµ± ---
        let audioCtx;
        let muyuInterval;
        let muyuEnabled = true;
        let ttsEnabled = false;
        let speechUtterance = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playWoodBlock() {
            if (!audioCtx || !muyuEnabled) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.05);
            
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }

        function speakText(text) {
            if (!ttsEnabled) return;
            window.speechSynthesis.cancel();
            speechUtterance = new SpeechSynthesisUtterance(text);
            speechUtterance.lang = 'zh-TW';
            speechUtterance.rate = 0.8; // å¤§æ‚²å’’èªé€Ÿå¯ä»¥ç¨æ…¢
            speechUtterance.pitch = 0.8; 
            window.speechSynthesis.speak(speechUtterance);
        }

        function stopSpeaking() {
            window.speechSynthesis.cancel();
        }

        // --- 3. ä¸»è¦é‚è¼¯ ---
        let count = 0;
        let isPaused = false;
        let currentKey = 'heart';

        const textEl = document.getElementById('scrollText');
        const countEl = document.getElementById('countNum');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const selectEl = document.getElementById('scriptureSelect');
        const muyuToggle = document.getElementById('muyuToggle');
        const ttsToggle = document.getElementById('ttsToggle');

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const dedicateName = urlParams.get('for');
            if (dedicateName) {
                const banner = document.getElementById('dedicationBanner');
                banner.textContent = `ğŸ”” å®ï¼æ”¶åˆ°ä¾†è‡ªæœ‹å‹çš„å›å‘ï¼Œç¥é¡˜ï¼šã€Œ${decodeURIComponent(dedicateName)}ã€`;
                banner.style.display = 'block';
                setTimeout(() => { banner.style.display = 'none'; }, 6000);
            }
            updateScripture();
        }

        function updateScripture() {
            currentKey = selectEl.value;
            textEl.textContent = scriptures[currentKey];
            textEl.style.animationDuration = `${speeds[currentKey]}s`;
        }

        muyuToggle.addEventListener('click', () => {
            muyuEnabled = !muyuEnabled;
            muyuToggle.classList.toggle('active');
            muyuToggle.textContent = muyuEnabled ? 'ğŸª˜ é›»å­æœ¨é­š (é–‹)' : 'ğŸª˜ é›»å­æœ¨é­š (é—œ)';
        });

        ttsToggle.addEventListener('click', () => {
            ttsEnabled = !ttsEnabled;
            ttsToggle.classList.toggle('active');
            ttsToggle.textContent = ttsEnabled ? 'ğŸ—£ï¸ AI èª¦è®€ (é–‹)' : 'ğŸ—£ï¸ AI èª¦è®€ (é—œ)';
        });

        startBtn.addEventListener('click', () => {
            initAudio();
            textEl.classList.add('scrolling');
            textEl.style.animationPlayState = 'running';
            
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            stopBtn.style.display = 'inline-block';
            selectEl.disabled = true;
            
            isPaused = false;
            pauseBtn.textContent = "ä¸”æ…¢ â¸";

            clearInterval(muyuInterval);
            muyuInterval = setInterval(playWoodBlock, 800); // æœ¨é­šé€Ÿåº¦

            if (ttsEnabled) speakText(textEl.textContent);
        });

        pauseBtn.addEventListener('click', () => {
            if (!isPaused) {
                textEl.style.animationPlayState = 'paused';
                pauseBtn.textContent = "ç¹¼çºŒ â–¶";
                clearInterval(muyuInterval);
                window.speechSynthesis.pause();
                isPaused = true;
            } else {
                initAudio();
                textEl.style.animationPlayState = 'running';
                pauseBtn.textContent = "ä¸”æ…¢ â¸";
                muyuInterval = setInterval(playWoodBlock, 800);
                window.speechSynthesis.resume();
                if(ttsEnabled && !window.speechSynthesis.speaking) speakText(textEl.textContent);
                isPaused = false;
            }
        });

        stopBtn.addEventListener('click', () => {
            textEl.classList.remove('scrolling');
            void textEl.offsetWidth;
            
            clearInterval(muyuInterval);
            stopSpeaking();

            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            stopBtn.style.display = 'none';
            selectEl.disabled = false;
            startBtn.textContent = "å†å¿µä¸€æ¬¡ â–¶";
            
            document.getElementById('finalCount').textContent = count;
            document.getElementById('dedicationModal').classList.add('active');
        });

        textEl.addEventListener('animationiteration', () => {
            count++;
            countEl.textContent = count;
            if(ttsEnabled) speakText(textEl.textContent);
        });

        selectEl.addEventListener('change', () => {
            count = 0;
            countEl.textContent = 0;
            updateScripture();
        });

        document.getElementById('shareBtn').addEventListener('click', () => {
            const val = document.getElementById('dedicateTo').value.trim() || "çœ¾ç”Ÿ";
            const url = `${window.location.href.split('?')[0]}?for=${encodeURIComponent(val)}`;
            navigator.clipboard.writeText(url).then(() => {
                document.getElementById('shareResult').style.display = 'block';
            });
        });
        
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('dedicationModal').classList.remove('active');
            document.getElementById('shareResult').style.display = 'none';
        });

        init();
    </script>
</body>
</html>
